{% extends "base.html" %}

{% block title %}Social Hub - Summary Detail{% endblock %}

{% block header_primary_text %}Summary{% endblock %}
{% block header_dashboard_text %}Detail{% endblock %}

{% block main_content_section %}
    <section class="summary-detail-container">
        <div class="detail-header">
            <h2 id="detail-title"></h2>
            <div class="detail-meta" id="detail-meta"></div>
        </div>

        <div class="detail-content-layout">
            <div class="left-column">
                <div class="audio-player-card card">
                    <h3>音频播放</h3>
                    <audio controls id="audio-player" style="width: 100%;"></audio>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span> / <span id="total-duration">0:00</span>
                    </div>
                </div>

                <div class="transcription-card card">
                    <h3>文字提取 (Transcription)</h3>
                    <div id="transcription-content"></div>
                </div>
            </div>

            <div class="right-column">
                <div class="ai-summary-card card">
                    <h3>AI 总结 (AI Summary)</h3>
                    <div id="ai-summary-content"></div>
                    <div class="query-section">
                        <textarea id="query-input" placeholder="在这里输入您关于摘录的问题..."></textarea>
                        <button id="send-query-btn">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_styles %}
    <style>
        .summary-detail-container {
            background-color: var(--bg-light-grey);
            border-radius: var(--border-radius-card);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .detail-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .detail-header h2 {
            font-size: 2.2rem;
            color: var(--primary-purple);
            margin-bottom: 10px;
        }

        .detail-meta {
            font-size: 1rem;
            color: var(--text-light);
        }

        .detail-meta span {
            margin: 0 10px;
        }

        .detail-content-layout {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .left-column {
            flex: 2; /* Takes 2/3 of the space */
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px; /* Minimum width for left column */
        }

        .right-column {
            flex: 1; /* Takes 1/3 of the space */
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 200px; /* Minimum width for right column */
        }

        .audio-player-card, .transcription-card, .ai-summary-card {
            padding: 20px;
            flex-grow: 1; /* Allow cards to grow within their columns */
        }

        .audio-player-card h3, .transcription-card h3, .ai-summary-card h3 {
            color: var(--primary-purple);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--bg-light-grey);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-purple);
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        #transcription-content, #ai-summary-content {
            white-space: pre-wrap; /* Preserves whitespace and wraps text */
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-dark);
        }

        .query-section {
            display: flex;
            gap: 10px;
            padding: 20px;
            align-items: center;
            margin-top: 20px; /* Space from content above */
        }

        #query-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid var(--bg-light-grey);
            border-radius: var(--border-radius-small);
            font-size: 1rem;
            min-height: 60px; /* Ensure enough height for typing */
            resize: vertical; /* Allow vertical resizing */
            outline: none;
            color: var(--text-dark);
            background-color: var(--bg-light-grey);
        }

        #query-input:focus {
            border-color: var(--primary-purple);
        }

        #send-query-btn {
            background-color: var(--primary-purple);
            color: var(--text-white);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #send-query-btn:hover {
            background-color: #7B5CD6;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .detail-content-layout {
                flex-direction: column; /* Stack columns on smaller screens */
            }
            .left-column, .right-column {
                min-width: unset; /* Remove min-width constraint */
                width: 100%;
            }
            .query-section {
                flex-direction: column;
                align-items: stretch;
            }
            #send-query-btn {
                width: 100%;
            }
        }
    </style>
{% endblock %}

{% block extra_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get filename directly from Jinja2 context
            const filename = "{{ filename }}"; 

            if (filename) {
                fetch(`/api/recordings/${filename}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('detail-title').textContent = data.title;
                        document.getElementById('detail-meta').innerHTML = `
                            <span>日期: ${data.date}</span>
                            <span>时长: ${data.duration}</span>
                            <span>参与者: ${data.participants}</span>
                        `;
                        
                        const audioPlayer = document.getElementById('audio-player');
                        audioPlayer.src = data.audio_url;

                        document.getElementById('transcription-content').textContent = data.transcription;
                        document.getElementById('ai-summary-content').textContent = data.ai_summary;

                        // Audio player progress
                        const progressBar = document.getElementById('progress-bar');
                        const currentTimeSpan = document.getElementById('current-time');
                        const totalDurationSpan = document.getElementById('total-duration');

                        audioPlayer.addEventListener('timeupdate', () => {
                            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                            progressBar.style.width = `${progress}%`;
                            currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
                        });

                        audioPlayer.addEventListener('loadedmetadata', () => {
                            totalDurationSpan.textContent = formatTime(audioPlayer.duration);
                        });

                        audioPlayer.addEventListener('ended', () => {
                            progressBar.style.width = '100%';
                            currentTimeSpan.textContent = totalDurationSpan.textContent;
                        });

                    })
                    .catch(error => {
                        console.error('Error fetching recording detail:', error);
                        document.getElementById('detail-title').textContent = '加载详情失败';
                        document.getElementById('detail-meta').textContent = '请检查文件名或网络连接。';
                    });
            } else {
                document.getElementById('detail-title').textContent = '未找到录音';
                document.getElementById('detail-meta').textContent = '请提供有效的录音文件名。';
            }
        });

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }
    </script>
{% endblock %}
